{% extends "admin/base.html" %}

{% load static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.9.2/jsoneditor.min.css" rel="stylesheet" type="text/css">
{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">{{ site_header|default:_('Django administration') }}</a></h1>
{% endblock %}

{% block nav-global %}
{{ block.super }}
<button id="toggleButton" onclick="toggleRequest()" style="margin-left: 10px;">G</button>
{% endblock %}

{% block footer %}
    {{ block.super }}
    {% include 'json_editor.html' %}

    <!-- Embed data for JavaScript -->
    {% if flows_data %}
        {{ flows_data|json_script:"initial-data" }}
    {% else %}
        <script>console.log('flows_data is not available in the context');</script>
    {% endif %}

    <script>
        const initialDataElement = document.getElementById('initial-data');
        try {
            const initialData = JSON.parse(initialDataElement ? initialDataElement.textContent : '{}');
            window.initialData = {
                flows: initialData || []
            };
        } catch (error) {
            window.initialData = { flows: [] };
        }

        let isGoogle = true;
        function toggleRequest() {
            const button = document.getElementById('toggleButton');
            const url = isGoogle ? 'http://127.0.0.1:8000/workspaces/1/admin/flow_runs/flowrun/add/?flow_mode=true': 'http://127.0.0.1:8000/workspaces/1/admin/flow_runs/flowrun/add/?flow_mode=false';
            const method = isGoogle ? 'GET' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: method === 'POST' ? JSON.stringify({ key: 'value' }) : undefined
            })
            .then(response => {
                if (response.headers.get("content-type").includes("application/json")) {
                    return response.json();
                } else {
                    return response.text();
                }
            })
            .then(data => {
                console.log('Success:', data);
                button.textContent = isGoogle ? 'F' : 'G';
                isGoogle = !isGoogle;
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    </script>

    <script src="{% static 'bluewind/js/admin_shortcuts.js' %}"></script>
{% endblock %}
