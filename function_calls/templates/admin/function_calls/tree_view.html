{% load i18n unfold static %}

{% block extrahead %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <style>
        .jstree-default .jstree-icon:empty {
            width: 0px;
        }
        .jstree-default .jstree-anchor { padding: 2px 4px; line-height: 24px; height: 24px; }
        #tree .jstree-wholerow { height: 24px; }

        /* New styles to ensure tree view stays on top */
        #tree-container {
            z-index: 100;
        }
    </style>
{% endblock %}

{% block content %}
<div id="tree-container" class="h-screen w-[250px] z-100 border-r border-gray-200 ">
    <div id="tree" class="overflow-y-auto h-[calc(100%-32px)]"></div>
</div>

    <div id="content-area">
        <!-- This is where the loaded content will appear -->
    </div>

    <script>
        $(function () {
            console.log("Script starting");

            // Function to get URL parameters
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                var results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            }

            // Extract the node ID from the current URL
            var currentPath = window.location.pathname;
            var matches = currentPath.match(/\/functioncall\/(\d+)\/change\//);
            var currentNodeId = matches ? matches[1] : null;

            // If not found in the path, look for it in query parameters
            if (!currentNodeId) {
                currentNodeId = getUrlParameter('function_call');
            }

            var tree = $('#tree').jstree({
                'core' : {
                    'data' : {{ tree_json|safe }},
                    'themes': {
                        'icons': false,
                        'variant': 'small',
                        'stripes': false
                    },
                    'animation': 0,
                    'multiple': false
                },
                'plugins': ['wholerow']
            }).on('ready.jstree', function(e, data) {
                console.log("Tree is ready");
                data.instance.open_all();

                if (currentNodeId) {
                    data.instance.select_node(currentNodeId);
                }
            });

            $(document).on('click', '#tree .jstree-anchor', function(e) {
                e.preventDefault();
                e.stopPropagation();

                var $node = $(this);
                var nodeId = $node.closest('li').attr('id');
                console.log("Click on node:", nodeId);

                var changeUrl = "/function_calls/functioncall/" + nodeId + "/change/";
                console.log("Attempting to navigate to:", changeUrl);
                window.location.href = changeUrl;
            });

            console.log("Event handlers set up");
        });
    </script>

{% endblock %}
