{% load i18n unfold static %}

{% block extrahead %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <style>
        body, html { margin: 0 !important; padding: 0 !important;}
        #header, #container, #content, #content-main {
            padding: 0 !important;
            margin: 0 !important;
            left: 200px !important;
            position: absolute !important;
            width: calc(100% - 200px) !important;
        }
        #header { top: 0 !important; height: 50px !important; }
        #container { top: 50px !important; bottom: 0 !important; overflow: auto !important; }
        .jstree-default .jstree-anchor { padding: 2px 4px !important; line-height: 24px !important; height: 24px !important; }
        .jstree-default .jstree-node { min-height: 24px !important; line-height: 24px !important; }
        #tree .jstree-wholerow { height: 24px !important; }
        #tree { font-size: 12px !important; }
        .change-link { font-size: 10px !important; padding: 0 2px !important; margin-left: 4px !important; }
    </style>
{% endblock %}

{% block content %}
    <div class="fixed left-0 top-0 h-full z-50 w-50 bg-white border-r shadow-lg overflow-hidden">
        <div id="tree" class="overflow-y-auto h-[calc(100%-32px)]"></div>
    </div>

    <div id="content-area">
        <!-- This is where the loaded content will appear -->
    </div>

    <script>
        $(function () {
            console.log("Script starting");

            var tree = $('#tree').jstree({
                'core' : {
                    'data' : {{ tree_json|safe }},
                    'themes': {
                        'icons': false,
                        'variant': 'small',
                        'stripes': false
                    },
                    'animation': 0
                },
                'plugins': ['wholerow']
            }).on('ready.jstree', function(e, data) {
                console.log("Tree is ready");
            });

            var clickTimer = null;
            var preventSimpleClick = false;

            $(document).on('click', '#tree .jstree-anchor', function(e) {
                e.preventDefault();
                e.stopPropagation();

                var $node = $(this);
                var nodeId = $node.closest('li').attr('id');
                console.log("Click on node:", nodeId);

                if (clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                    preventSimpleClick = true;
                    console.log("Double click detected on node:", nodeId);
                    var changeUrl = "/workspaces/2/admin/function_calls/functioncall/" + nodeId + "/change/";
                    console.log("Attempting to navigate to:", changeUrl);
                    window.location.href = changeUrl;
                    console.log("Attempting to load:", changeUrl);
                } else {
                    clickTimer = setTimeout(function() {
                        clickTimer = null;
                        if (!preventSimpleClick) {
                            console.log("Single click on node:", nodeId);
                            tree.jstree('toggle_node', $node);
                        }
                        preventSimpleClick = false;
                    }, 170);
                }
            });

            console.log("Event handlers set up");
        });
    </script>
{% endblock %}
